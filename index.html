<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÉ Halloween Valley - RPG Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #0a0015 0%, #1a0033 50%, #2d0052 100%);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
        }
        
        /* Animated Background */
        .bg-stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        #gameContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1;
    background: #000;
    overflow: hidden;
}
        
        #canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* HUD */
.hud {
    position: fixed;
    top: 15px;
    left: 15px;
            background: rgba(10, 10, 10, 0.95);
            border: 4px solid #ff6b00;
            border-radius: 15px;
            padding: 15px 25px;
            z-index: 100;
            box-shadow: 0 0 30px rgba(255, 107, 0, 0.8), inset 0 0 20px rgba(255, 107, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .hud-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            font-size: 11px;
            color: #fff;
        }
        
        .hud-label {
            color: #ffa500;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.8);
            min-width: 25px;
        }
        
        .hud-value {
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }
        
        .bar-container {
            width: 140px;
            height: 18px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #666;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000 0%, #ff6b00 100%);
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
        }
        
        .energy-bar .bar-fill {
            background: linear-gradient(90deg, #00ff88 0%, #00cc66 100%);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }
        
        /* Inventory */
.inventory {
    position: fixed;
    top: 15px;
    right: 15px;
            background: rgba(10, 10, 10, 0.95);
            border: 4px solid #ff6b00;
            border-radius: 15px;
            padding: 15px;
            z-index: 100;
            box-shadow: 0 0 30px rgba(255, 107, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .inv-title {
            font-size: 10px;
            color: #ffa500;
            text-align: center;
            margin-bottom: 12px;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.8);
        }
        
        .inv-grid {
            display: grid;
            grid-template-columns: repeat(4, 60px);
            gap: 8px;
        }
        
        .inv-slot {
            width: 60px;
            height: 60px;
            background: rgba(20, 20, 40, 0.8);
            border: 3px solid #444;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .inv-slot:hover {
            border-color: #888;
            transform: scale(1.08);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.5);
        }
        
        .inv-slot.has-item {
            background: rgba(255, 165, 0, 0.2);
            border-color: #ffa500;
            animation: itemPulse 2s infinite;
        }
        
        .inv-slot.selected {
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.9);
            background: rgba(0, 255, 0, 0.15);
        }
        
        .inv-count {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            color: #fff;
            background: rgba(0, 0, 0, 0.9);
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid #ffa500;
        }
        
        @keyframes itemPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 165, 0, 0.4); }
            50% { box-shadow: 0 0 25px rgba(255, 165, 0, 1); }
        }
        
        /* Quest Panel */
.quest-panel {
    position: fixed;
    bottom: 15px;
    left: 15px;
    max-width: 400px;
            background: rgba(10, 10, 10, 0.95);
            border: 4px solid #ff6b00;
            border-radius: 15px;
            padding: 15px;
            z-index: 100;
            box-shadow: 0 0 30px rgba(255, 107, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .quest-title {
            font-size: 10px;
            color: #ffa500;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.8);
        }
        
        .quest-item {
            font-size: 9px;
            color: #fff;
            margin: 6px 0;
            padding: 8px;
            background: rgba(255, 107, 0, 0.1);
            border-left: 3px solid #ff6b00;
            border-radius: 5px;
        }
        
        .quest-item.completed {
            color: #00ff88;
            border-left-color: #00ff88;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* Minimap */
.minimap {
    position: fixed;
    bottom: 15px;
    right: 15px;
    width: 250px;
    height: 180px;
            background: rgba(10, 10, 10, 0.95);
            border: 4px solid #ff6b00;
            border-radius: 15px;
            padding: 10px;
            z-index: 100;
            box-shadow: 0 0 30px rgba(255, 107, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .minimap-title {
            font-size: 8px;
            color: #ffa500;
            text-align: center;
            margin-bottom: 5px;
        }
        
        #minimapCanvas {
            width: 100%;
            height: calc(100% - 20px);
            border: 2px solid #444;
            border-radius: 5px;
            image-rendering: pixelated;
        }
        
        /* Mobile Controls */
        .mobile-controls {
            position: fixed;
            bottom: 200px;
            left: 30px;
            display: none;
            z-index: 100;
        }
        
        .dpad {
            position: relative;
            width: 180px;
            height: 180px;
        }
        
        .btn-dpad {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b00 0%, #ff9500 100%);
            border: 4px solid rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            font-size: 24px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 107, 0, 0.6);
            touch-action: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .btn-dpad:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 107, 0, 0.6);
        }
        
        .btn-dpad.up { top: 0; left: 60px; }
        .btn-dpad.down { bottom: 0; left: 60px; }
        .btn-dpad.left { top: 60px; left: 0; }
        .btn-dpad.right { top: 60px; right: 0; }
        
        .action-buttons {
            position: fixed;
            bottom: 240px;
            right: 240px;
            display: none;
            gap: 15px;
            z-index: 100;
        }
        
        .btn-action {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            border: 5px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            font-size: 12px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.5), 0 0 25px rgba(0, 255, 0, 0.6);
            touch-action: none;
            text-align: center;
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            cursor: pointer;
        }
        
        .btn-action:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.5), 0 0 25px rgba(0, 255, 0, 0.6);
        }
        
        /* Tooltip */
        .tooltip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: #ffa500;
            padding: 15px 30px;
            border-radius: 15px;
            border: 4px solid #ff6b00;
            font-size: 12px;
            z-index: 250;
            pointer-events: none;
            animation: tooltipFade 2.5s forwards;
            box-shadow: 0 0 30px rgba(255, 107, 0, 0.9);
            max-width: 80%;
            text-align: center;
        }
        
        @keyframes tooltipFade {
            0% { opacity: 0; transform: translate(-50%, -60%); }
            15%, 85% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -40%); }
        }
        
        /* Menu Overlays */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .menu-content {
            background: linear-gradient(135deg, #2d0052 0%, #4a0080 50%, #ff6b00 100%);
            border: 6px solid #ffa500;
            border-radius: 25px;
            padding: 40px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 80px rgba(255, 165, 0, 0.9), inset 0 0 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.4s;
        }
        
        @keyframes slideIn {
            from {
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        .menu-title {
            font-size: 36px;
            color: #ffa500;
            margin-bottom: 30px;
            text-shadow: 4px 4px 0 #000, 0 0 20px rgba(255, 165, 0, 0.8);
            animation: titleFloat 2s ease-in-out infinite;
        }
        
        @keyframes titleFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        
        .menu-subtitle {
            font-size: 14px;
            color: #00ff88;
            margin-bottom: 25px;
            text-shadow: 2px 2px 0 #000, 0 0 15px rgba(0, 255, 136, 0.8);
        }
        
        .menu-text {
            font-size: 11px;
            color: #fff;
            line-height: 1.8;
            margin: 15px 0;
            text-shadow: 2px 2px 0 #000;
        }
        
        .menu-text strong {
            color: #ffa500;
        }
        
        .menu-btn {
            background: linear-gradient(135deg, #ff6b00 0%, #cc5500 100%);
            border: 4px solid #fff;
            border-radius: 12px;
            padding: 15px 35px;
            font-family: 'Press Start 2P', cursive;
            font-size: 13px;
            color: #fff;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.4), 0 0 25px rgba(255, 107, 0, 0.6);
            text-shadow: 2px 2px 0 #000;
            transition: all 0.2s;
            display: inline-block;
            border: none;
            outline: none;
        }
        
        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 rgba(0, 0, 0, 0.4), 0 0 35px rgba(255, 107, 0, 0.9);
        }
        
        .menu-btn:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.4), 0 0 25px rgba(255, 107, 0, 0.6);
        }
        
        .menu-btn.secondary {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: #000;
        }
        
        .menu-input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            border: 4px solid #ffa500;
            border-radius: 12px;
            color: #fff;
            text-align: center;
            margin: 20px auto;
            display: block;
            box-shadow: inset 0 0 20px rgba(255, 107, 0, 0.3);
            outline: none;
        }
        
        .menu-input:focus {
            border-color: #00ff88;
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.6);
        }
        
        /* Cape Box */
        .cape-box {
            background: linear-gradient(135deg, #ffa500 0%, #ff6b00 100%);
            padding: 25px;
            border-radius: 18px;
            margin: 20px 0;
            border: 5px solid #fff;
            animation: capePulse 2.5s infinite;
            box-shadow: 0 0 40px rgba(255, 165, 0, 0.8);
        }
        
        @keyframes capePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 40px rgba(255, 165, 0, 0.8);
            }
            50% { 
                transform: scale(1.03);
                box-shadow: 0 0 60px rgba(255, 165, 0, 1);
            }
        }
        
        .cape-code {
            font-size: 13px;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            word-break: break-all;
            border: 3px dashed #fff;
            color: #fff;
            text-shadow: none;
        }
        
        /* Ranking Table */
        .ranking-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .ranking-table {
            background: rgba(0, 0, 0, 0.8);
            border: 4px solid #ffa500;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ranking-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .ranking-table th {
            padding: 12px;
            text-align: left;
            font-size: 11px;
            color: #ffa500;
            border-bottom: 2px solid #ff6b00;
        }
        
        .ranking-table td {
            padding: 10px;
            font-size: 11px;
            color: #fff;
            border-bottom: 1px solid rgba(255, 107, 0, 0.2);
        }
        
        .ranking-table tr:hover {
            background: rgba(255, 107, 0, 0.1);
        }
        
        .player-row {
            background: rgba(0, 255, 136, 0.2) !important;
            color: #00ff88 !important;
        }
        
        .hidden {
            display: none !important;
        }
        
        .watermark {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #ff6b00;
            font-size: 9px;
            color: #ff9500;
            z-index: 99;
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.5);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .mobile-controls,
            .action-buttons {
                display: flex;
            }
            
            .hud {
                font-size: 9px;
                padding: 10px 15px;
            }
            
            .inv-grid {
                grid-template-columns: repeat(3, 50px);
            }
            
            .inv-slot {
                width: 50px;
                height: 50px;
                font-size: 28px;
            }
            
            .menu-title {
                font-size: 22px;
            }
            
            .menu-subtitle {
                font-size: 12px;
            }
            
            .menu-text {
                font-size: 9px;
            }
            
            .menu-btn {
                font-size: 11px;
                padding: 12px 25px;
            }
            
            .minimap {
                width: 150px;
                height: 110px;
            }
            
            .quest-panel {
                max-width: 250px;
                font-size: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .menu-title {
                font-size: 18px;
            }
            
            .menu-content {
                padding: 25px;
            }
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0033 0%, #2d0052 50%, #4a0080 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }
        
        .loading-content h1 {
            color: #ff8c00;
            font-size: 32px;
            margin-bottom: 40px;
            text-shadow: 4px 4px 0 #000, 0 0 20px rgba(255, 140, 0, 0.8);
            animation: titleFloat 2s ease-in-out infinite;
        }
        
        .loading-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 4px solid #ff6b00;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.6);
        }
        
        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b00 0%, #ffa500 50%, #ff6b00 100%);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.3s;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loading-text {
            color: #00ff88;
            font-size: 14px;
            text-shadow: 2px 2px 0 #000, 0 0 10px rgba(0, 255, 136, 0.8);
        }
    </style>
</head>
<body>
    <!-- Background Stars -->
    <div class="bg-stars" id="bgStars"></div>
    
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <h1>üéÉ HALLOWEEN VALLEY üéÉ</h1>
            <div class="loading-bar">
                <div class="loading-fill" id="loadingFill"></div>
            </div>
            <p class="loading-text" id="loadingText">Carregando recursos...</p>
        </div>
    </div>
    
    <!-- Game Container -->
    <div id="gameContainer">
        <canvas id="canvas"></canvas>
    </div>
    
    <!-- HUD -->
    <div class="hud hidden" id="hud">
        <div class="hud-row">
            <span class="hud-label">üë§</span>
            <span class="hud-value" id="playerName">-</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">‚ù§Ô∏è</span>
            <div class="bar-container">
                <div class="bar-fill" id="healthBar" style="width: 100%"></div>
            </div>
            <span class="hud-value"><span id="healthValue">100</span>/100</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">‚ö°</span>
            <div class="bar-container energy-bar">
                <div class="bar-fill" id="energyBar" style="width: 100%"></div>
            </div>
            <span class="hud-value"><span id="energyValue">100</span>/100</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">üí∞</span>
            <span class="hud-value" id="goldValue">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">üéÉ</span>
            <span class="hud-value"><span id="pumpkinCount">0</span>/10</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">‚è±Ô∏è</span>
            <span class="hud-value" id="timeValue">0:00</span>
        </div>
    </div>
    
    <!-- Inventory -->
    <div class="inventory hidden" id="inventory">
        <div class="inv-title">üì¶ INVENT√ÅRIO</div>
        <div class="inv-grid" id="invGrid"></div>
    </div>
    
    <!-- Minimap -->
    <div class="minimap hidden" id="minimap">
        <div class="minimap-title">üó∫Ô∏è MAPA</div>
        <canvas id="minimapCanvas" width="180" height="120"></canvas>
    </div>
    
    <!-- Quest Panel -->
    <div class="quest-panel hidden" id="questPanel">
        <div class="quest-title">üìú MISS√ïES</div>
        <div id="questList"></div>
    </div>
    
    <!-- Mobile Controls -->
    <div class="mobile-controls">
        <div class="dpad">
            <div class="btn-dpad up" data-dir="up">‚ñ≤</div>
            <div class="btn-dpad down" data-dir="down">‚ñº</div>
            <div class="btn-dpad left" data-dir="left">‚óÄ</div>
            <div class="btn-dpad right" data-dir="right">‚ñ∂</div>
        </div>
    </div>
    
    <div class="action-buttons">
        <div class="btn-action" id="btnInteract">USAR<br>üí¨</div>
    </div>
    
    <!-- Nick Screen -->
    <div class="menu-overlay" id="nickScreen">
        <div class="menu-content">
            <div class="menu-title">üéÉ HALLOWEEN VALLEY üéÉ</div>
            <div class="menu-subtitle">‚ú® Uma Aventura de Halloween ‚ú®</div>
            <div class="menu-text">
                <p style="margin: 20px 0;">Digite seu nick para come√ßar a aventura!</p>
            </div>
            <input 
                type="text" 
                id="nickInput" 
                class="menu-input" 
                placeholder="Seu Nick Aqui" 
                maxlength="15"
                autocomplete="off"
            >
<button class="menu-btn" onclick="submitNick()">‚úÖ CONTINUAR</button>
            <button class="menu-btn secondary" onclick="showRankings()">üèÜ VER RANKINGS</button>
        </div>
    </div>
    
    <!-- Start Screen -->
    <div class="menu-overlay hidden" id="startScreen">
        <div class="menu-content">
            <div class="menu-title">üéÉ HALLOWEEN VALLEY üéÉ</div>
            <div class="menu-subtitle">‚ú® A Halloween Adventure ‚ú®</div>
            <div class="menu-text">
                <p style="font-size: 15px; color: #ffa500; margin: 20px 0;">üó∫Ô∏è EXPLORE UM MUNDO M√ÅGICO!</p>
                
                <p><strong>üéØ SUA MISS√ÉO:</strong></p>
                <p>Encontre as <strong>10 AB√ìBORAS M√ÅGICAS</strong> escondidas pelo vale!</p>
                <p>Interaja com NPCs, complete miss√µes e desbloqueie segredos!</p>
                <br>
                
                <p><strong>üîß FERRAMENTAS:</strong></p>
                <p>ü™ì <strong>Machado</strong> - Corte √°rvores e colete madeira</p>
                <p>‚õèÔ∏è <strong>Picareta</strong> - Quebre pedras e minere recursos</p>
                <p>üîë <strong>Chave</strong> - Abra portas e ba√∫s trancados</p>
                <p>üç¨ <strong>Doces</strong> - Recupere energia</p>
                <p>üß™ <strong>Po√ß√µes</strong> - Recupere vida</p>
                <br>
                
                <p><strong>üéÆ CONTROLES:</strong></p>
                <p><strong>PC:</strong> WASD ou Setas para mover ‚Ä¢ E ou Espa√ßo para interagir</p>
                <p><strong>Mobile:</strong> Use o D-Pad e bot√£o de a√ß√£o na tela</p>
                <p><strong>Invent√°rio:</strong> Clique nos itens para equipar</p>
                <br>
                
                <p style="color: #00ff88; font-size: 13px; margin-top: 20px;">
                    ‚≠ê Complete todas as miss√µes e ganhe uma <strong>CAPA OPTIFINE EXCLUSIVA</strong>! ‚≠ê
                </p>
            </div>
            <button class="menu-btn" onclick="startGame()">üöÄ COME√áAR AVENTURA</button>
            <button class="menu-btn secondary" onclick="showControls()">üéÆ MAIS INFO</button>
        </div>
    </div>
    
    <!-- Victory Screen -->
    <div class="menu-overlay hidden" id="victoryScreen">
        <div class="menu-content">
            <div class="menu-title">üèÜ PARAB√âNS! üèÜ</div>
            <div class="menu-subtitle">‚ú® Voc√™ completou Halloween Valley! ‚ú®</div>
            <div class="menu-text">
                <p style="font-size: 17px; margin: 20px 0; color: #00ff88;">
                    üéÉ Todas as 10 ab√≥boras m√°gicas foram encontradas! üéÉ
                </p>
                
                <div class="cape-box">
                    <h2 style="font-size: 20px; margin-bottom: 15px; color: #fff;">
                        üéÅ SUA RECOMPENSA üéÅ
                    </h2>
                    <p style="font-size: 11px; margin: 10px 0; color: #fff;">
                        C√≥digo exclusivo de Capa Optifine:
                    </p>
                    <div class="cape-code" id="capeCode">CARREGANDO...</div>
                    <button class="menu-btn" onclick="copyCape()">üìã COPIAR C√ìDIGO</button>
                    <p style="font-size: 10px; margin-top: 10px; color: #fff;">
                        ‚ö†Ô∏è Use este c√≥digo em <strong>optifine.net/login</strong>
                    </p>
                </div>
                
                <div style="background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px; margin: 20px 0; border: 3px solid #00ff88;">
                    <p style="font-size: 14px; color: #00ff88; margin-bottom: 10px;">
                        ‚è±Ô∏è SEU TEMPO
                    </p>
                    <p style="font-size: 20px; color: #ffa500;" id="finalTime">0:00</p>
                    <p style="font-size: 14px; color: #00ff88; margin: 15px 0 10px 0;">
                        üí∞ PONTUA√á√ÉO FINAL
                    </p>
                    <p style="font-size: 20px; color: #ffa500;" id="finalScore">0</p>
                </div>
                
                <p style="font-size: 13px; margin-top: 20px;">
                    Obrigado por jogar! üéÆ
                </p>
            </div>
            <button class="menu-btn secondary" onclick="showRankingsFromVictory()">üèÜ VER RANKINGS</button>
            <button class="menu-btn" onclick="showCredits()">üé¨ VER CR√âDITOS</button>
            <button class="menu-btn" onclick="restartGame()">üîÑ JOGAR NOVAMENTE</button>
        </div>
    </div>
    
    <!-- Rankings Screen -->
    <div class="menu-overlay hidden" id="rankingsScreen">
        <div class="menu-content" style="max-width: 900px;">
            <div class="menu-title" style="font-size: 28px;">üèÜ RANKINGS üèÜ</div>
            
            <div class="ranking-tabs">
                <button class="menu-btn secondary" onclick="switchRankingTab('score')">
                    üíØ PONTUA√á√ÉO
                </button>
                <button class="menu-btn secondary" onclick="switchRankingTab('speed')">
                    ‚ö° MAIS R√ÅPIDOS
                </button>
                <button class="menu-btn secondary" onclick="switchRankingTab('pumpkins')">
                    üéÉ MAIS AB√ìBORAS
                </button>
            </div>
            
            <div class="ranking-table" id="rankingContent"></div>
            
            <button class="menu-btn" onclick="closeRankings()">üîô VOLTAR</button>
        </div>
    </div>
    
    <!-- Credits Screen -->
    <div class="menu-overlay hidden" id="creditsScreen">
        <div class="menu-content" style="max-width: 700px;">
            <div class="menu-title">üé¨ CR√âDITOS üé¨</div>
            <div class="menu-text" style="font-size: 12px; line-height: 2;">
                <p style="font-size: 24px; color: #ffa500; margin: 40px 0;">
                    üéÉ HALLOWEEN VALLEY üéÉ
                </p>
                
                <p style="margin: 30px 0;">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</p>
                
                <p style="font-size: 16px; color: #00ff88; margin: 20px 0;">
                    DESENVOLVIDO POR
                </p>
                <p style="font-size: 20px; color: #ffa500;">
                    VEGOTS
                </p>
                
                <p style="margin: 30px 0;">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</p>
                
                <p style="font-size: 16px; color: #00ff88; margin: 20px 0;">
                    EMPRESA
                </p>
                <p style="font-size: 20px; color: #ffa500;">
                    ‚ö° YORUS ‚ö°
                </p>
                
                <p style="margin: 30px 0;">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</p>
                
                <p style="font-size: 14px; margin: 20px 0;">
                    JUNTE-SE √Ä COMUNIDADE
                </p>
                <p>
                    <a href="https://discord.gg/ta6vzcqCum" target="_blank" style="color: #00ff88; text-decoration: none;">
                        üéÆ discord.gg/ta6vzcqCum
                    </a>
                </p>
                
                <p style="margin: 30px 0;">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</p>
                
                <p style="font-size: 14px; margin: 20px 0;">
                    AGRADECIMENTOS
                </p>
                <p style="font-size: 10px;">
                    A todos os jogadores que embarcaram<br>
                    nesta aventura de Halloween!
                </p>
                
                <p style="margin: 30px 0;">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</p>
                
                <p style="font-size: 18px; color: #00ff88; margin: 40px 0;">
                    üéÉ FELIZ HALLOWEEN! üéÉ
                </p>
                
                <p style="font-size: 10px; color: #888; margin-top: 40px;">
                    ¬© 2025 YORUS - Todos os direitos reservados
                </p>
            </div>
            <button class="menu-btn" onclick="closeCredits()">üîô VOLTAR</button>
        </div>
    </div>
    
    <div class="watermark">‚ö° YORUS - Created by VEGOTS</div>
    
    <script>
        'use strict';
        
        // ===== SISTEMA DE CAPAS =====
        (function(){
            const codes = [
                'a2FtaWwtYnVqYWxza2lAbzIucGw6NzVURTVYVlJISA==',
                'bGlsc2l4aW5va2M3QGdtYWlsLmNvbTpUQ085N1VRMjdX',
                'aW94ZGFyazM3Mnl0QGdtYWlsLmNvbTo4SE5UU0Q2MzVF',
                'Y29udGF0by5zNHp6eEBnbWFpbC5jb206WldMTzJaUlNDQw==',
                'bWF0MjkubWdAZ21haWwuY29tOkw0TFhYRU1LWEU=',
                'bWFydGlqbmRvb3JkdWluMjAwN0BnbWFpbC5jb206VlpWUlRJVFpONA==',
                'YWxjcmFmdDEyQGdtYWlsLmNvbTpOMjBZQVc2NldT',
                'c2xpbmV3b2xmQGdtYWlsLmNvbTozUlY5UkNXVEpT',
                'VGhvbWFzX2FuZGVyc2VuMzBAaG90bWFpbC5jb206Nk0xN0s5U1dIQw==',
                'cGVkcm9iYWlkYWwyMDE0QGhvdG1haWwuY29tOlhXN0NLUVBLOUk=',
                'amFtZXNodWxnYW5uQGdtYWlsLmNvbTpOQzZSVjlFMTNN',
                'emVuYS5raGVyYmVjaGVAZ21haWwuY29tOjhIODYyTzlRWTM=',
                'c2VpZmppZWRAeWFob28uY29tOkkxOUVGSjNMMEE=',
                'ZnJ1bW9zdTE5OTRAbWFpbC5ydTpFME1KSEVLREU=',
                'bHVjaWFubjc4NkBHbWFpbC5jb206WUswVUJRUE1MVg==',
                'ZGlvbi5kb21taXNzZUBnbWFpbC5jb206TU9aNFM2S1lKTg==',
                'd29qYWtha2FAZ21haWwuY29tOjNXQURWVFVQNDY=',
                'ZmlsaXBrb2N3aW5AZ21haWwuY29tOlkxOU8xOVhEU0g=',
                'Y3VucGh1YzEwQGdtYWlsLmNvbTo1SDVFMlNMRVNMOQ==',
                'Y29sZXlldGhhbkB5YWhvby5jb206UzE2SDRQMzIxTg==',
                'bG9raWRva2kyNmtvbG9AZ21haWwuY29tOklNUzRQT0YwSDM=',
                'bHVpemx1aXozenpwQGdtYWlsLmNvbTpZRlk2NUs3SDhX',
                'c2FtdWVsZ2ZyQGdtYWlsLmNvbTpWOURGT1E0VTNEA==',
                'ZHJhZ29ua25pZ2h0ODhAaG90bWFpbC5jb206U0pLSlFPRURXVw==',
                'bG9vbG9zaDc0QGdtYWlsLmNvbTpDN1k2TDFKNkRB',
                'bHh2aXNobGVvQGdtYWlsLmNvbTpDMU0xNVUxVldT',
                'eGVuZGVyYWxleF95dEBob3RtYWlsLmNvbTpJNkFTN1NSNzAy',
                'anVua3MyMDAxQGdtYWlsLmNvbToxQ1EzSTBMMkJC',
                'aWFtZGFib21iMTVAZ21haWwuY29tOlRDVExOOU1EWjk=',
                'emlnYS52b2RuanprNEBnbWFpbC5jb206SkE0SjRZMDJDMQ==',
                'bWV2ZWxhckB5YWhvby5jb206WExDRDNPOU9KUw==',
                'VmlwM3JmcmFtM0BnbWFpbC5jb206Rlk3STVPMVJYMQ==',
                'bW1vb25ncmF2ZXNAZ21haWwuY29tOjc4SUVFOUY5RjI=',
                'YnJhbnF1ZWxvb282OUBnbWFpbC5jb206VkFKTkE2QVY2OA==',
                'cmV4bHAxMDBAd2ViLmRlOjhOSzlVUTBWVFk=',
                'YWRyaWFuYS50aW5vY29AYm9sLmNvbS5icjo5ODlSMkhCWk5P',
                'aXZlcmEzNzIuaXY4M0BnbWFpbC5jb206MkpVRFZFWktVNw==',
                'Q2hyeXM2N0BsaXZlLml0OkFIQUgzMjZUMzU=',
                'cmFyYXkxMTlAeWFob28uY28uanA6V0FLMjcyV0Q3Mg==',
                'ZGFzLmRhbmllbEB0LW9ubGluZS5kZTpXUEU1VlVLMTBN',
                'cGFyazM0QGdtYWlsLmNvbTo4Q1RDWlZDWFNY',
                'dmVybzlAYmJveC5mcjpDRVlMTEY3UEE1',
                'QXJpZWxjYjA3QGdtYWlsLmNvbTpEMzBUMDUyUzVD',
                'cGFzY2FsZG9yaWFuMTQwNUBnbWFpbC5jb206RVk0N05XTjlRRQ==',
                'dGVvc2V2ZXJpbmlnaWxtYW50QGdtYWlsLmNvbTo3SVVCSFNTU1JWTg==',
                'bWFzc2ltby5hbmdoZWw4MEBpY2xvdWQuY29tOlBFME84Wk1DTTY=',
                'dml0b3JwNGNvbWJhZG9yQG91dGxvb2suY29tOkRLSVdRRkRKTTU=',
                'c2FyYXMuYXB1bHNraXNAZ21haWwuY29tOjJEM1hCQTk5NjU=',
                'bm9haC5tYWNlcmlAZ21haWwuY29tOkhaMFZFTjRDTE4=',
                'Y29sdG9ua21vc2xleUBnbWFpbC5jb206MjJFMDMwUk5UWQ==',
                'ZW1pbGlhbm9jb3JuMTAxQGdtYWlsLmNvbTpUWDdWVTNIR1o2',
                'Y2FtbXl3YW1teTMyd0BnbWFpbC5jb206N0ZSQUtYM05aOA==',
                'eWlzZTI3MTFAZ21haWwuY29tOjdXU1BQWTZMTlI=',
                'aHVuMjAxNzA4MTJAZ21haWwuY29tOllZWTJQSTNaU0w=',
                'd2dvbnphbG8yMkBnbWFpbC5jb206VTg4NFY1U0lISw==',
                'cmVsb2FkMjA1N0BnbWFpbC5jb206Tko4VDNKT0hBVw==',
                'Z3Jlc2tvLmFuZHJlajY5QGdtYWlsLmNvbTo4WlZXUVA0UFFQ',
                'UXVpY2tsZXk4OEBnbWFpbC5jb206RU9aTVJVVTA5Tg==',
                'a2tzaXBvc0BnbWFpbC5jb206MDNFQlpBNUkyRw==',
                'bWxhcm9jaGUyMDA1QGdtYWlsLmNvbTo5WUs5Tk1GMVZN',
                'YWFyb25zaHJzQGdtYWlsLmNvbTpCWUlQN1A2RThD',
                'S2FyZW52YW5jZTFAaG90bWFpbC5jb206ODhHTFVPSEU1MA==',
                'cm9jaGFpc2Fkb3JhMzdAZ21haWwuY29tOjU1UkVVRzVHTU4=',
                'YnJhbTI1MDgwNkBnbWFpbC5jb206ODFJNVBPUVRDTA==',
                'cmFmYWVsZnNvYnJvc2FAZ21haWwuY29tOk5CMzFWUlcyOEI=',
                'YWxhbnBhc3RyaWFuMTIzNDU2QGdtYWlsLmNvbTpJRTRDU1A0SEU5',
                'amtuaWprYW5AZ21haWwuY29tOlhYVzdJMzdPTEE=',
                'TmVkZXJraXBwaWVAZ21haWwuY29tOlBST1AzS05ZME0=',
                'YWhsYW1fYV81NTVAaG90bWFpbC5jb206Vk5IUU5LQjNXQw==',
                'bHVjYXNrZWxsbmVyMDhAeWFob28uY29tOktGUkxLQTA1Q00=',
                'bmFyb3preTI2LjQuZEBnbWFpbC5jb206T1ZaTUVCVjBZSQ==',
                'c3VwZXJwb2xhcjQ1MkBnbWFpbC5jb206QU0yNFpVQ05BNQ==',
                'dGltQGl0ZWFjaGVtLmNvbTo2OVlFUThIUDNK',
                'cHdpbGRlbjIzQGdtYWlsLmNvbToyT0dNQVk5OUlD',
                'YnJhbmRvbm1odXluaEBnbWFpbC5jb206VTFaNDZWV1JZUA==',
                'YWxpbi5jb3NtZWxlYXRhQGdtYWlsLmNvbTpYVkk5NjRZNTZG',
                'cGF0YW1vc2h0YTk3QGdtYWlsLmNvbTpXMTBCV0pBUFhF',
                'amhsZWU4NTYyQGdtYWlsLmNvbTpSMlc4N0NPMzJY',
                'bGlrZWRmb3J0bml0ZUB3ZWIuZGU6Q0tES1FKQzFPNQ==',
                'aWRhbmllbC5pbGFib3lAZ21haWwuY29tOjdYVVo4ODhET0g=',
                'Y2hpbGVhbmNqbUBnbWFpbC5jb206U1FEMkRLNlU0Qw==',
                'bG91aXNoYWdzcGllbDVAZ21haWwuY29tOlNWWEdCUVlUMlc=',
                'cm9iZXJ0b2QxNHVAZ21haWwuY29tOlpFVzRPWUFYUEw=',
                'bWhhY2tldHQyM0BnbWFpbC5jb206WU5PQk9SRzlOTg==',
                'dHJra2ViYWJAZ21haWwuY29tOjYzMU81N044V00=',
                'anVhbi5jYW1pbG8uMjcubGV5dG9uQGdtYWlsLmNvbTpCM1hVUVlWS0xG',
                'ZGVzdGlsbGFidXNpbmVzc0BnbWFpbC5jb206VVBSVDdBTzVZQg==',
                'bHJvZWhtQG5jLnJyLmNvbTpDTE8zSVZGQTkx',
                'bW9oYW1lZDZuYXNAZ21haWwuY29tOktXQ1pCV0pFN0Y=',
                'ZGJsdW1lbkB5YWhvby5jb206T1JMNFRXSUVRRDU=',
                'a3VraWthcmVva0BnbWFpbC5jb206M0tNSEVFUk9HSA==',
                'YW5kcmV3bGVvcmljaEBpY2xvdWQuY29tOllFUUpBOTQwV04=',
                'c3dlZWt6eUBnbWFpbC5jb206M0xIN1FLM1ZVSg==',
                'dmlwZWdpNDcwM0ByZWx1bXl4LmNvbTpIRjMwR1BJQVo4',
                'ZGF2aWRkZzc3Ny5kZzg1QGdtYWlsLmNvbTpHQUVOUFdGNU01',
                'Z2FuY2E5ODVAZ21haWwuY29tOlRSSlpNVldMMDg=',
                'UGF0cmlrLnZhY3VsaW5vQGdtYWlsLmNvbTo3TTlFM1NFN1Ex'
            ];
            
            window._getCape = function() {
                let index = parseInt(localStorage.getItem('_capeIndex') || '0');
                const cape = atob(codes[index]);
                index = (index + 1) % codes.length;
                localStorage.setItem('_capeIndex', index.toString());
                return cape;
            };
            
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if(e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73)) e.preventDefault();
            });
        })();
        
        // ===== SISTEMA DE RANKING =====
        class RankingSystem {
            static saveScore(nick, time, pumpkins, score) {
                const rankings = this.getRankings();
                const entry = {
                    nick: nick,
                    time: time,
                    pumpkins: pumpkins,
                    score: score,
                    date: new Date().toISOString(),
                    completed: pumpkins >= 10
                };
                
                rankings.push(entry);
                rankings.sort((a, b) => b.score - a.score);
                localStorage.setItem('halloweenValleyRankings', JSON.stringify(rankings.slice(0, 100)));
            }
            
            static getRankings() {
                const data = localStorage.getItem('halloweenValleyRankings');
                return data ? JSON.parse(data) : [];
            }
            
            static getTopScore() {
                return this.getRankings()
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);
            }
            
            static getTopSpeed() {
                return this.getRankings()
                    .filter(s => s.completed)
                    .sort((a, b) => a.time - b.time)
                    .slice(0, 10);
            }
            
            static getTopPumpkins() {
                return this.getRankings()
                    .sort((a, b) => b.pumpkins - a.pumpkins)
                    .slice(0, 10);
            }
            
            static formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }
        
        // ===== GAME SETUP =====
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimapCanvas');
        const minimapCtx = minimapCanvas.getContext('2d');
        
        // Configura√ß√£o
        const TILE_SIZE = 32;
const MAP_WIDTH = 60;
const MAP_HEIGHT = 45;

// Calcular viewport baseado no tamanho da tela
let VIEWPORT_WIDTH = Math.floor(window.innerWidth / TILE_SIZE);
let VIEWPORT_HEIGHT = Math.floor(window.innerHeight / TILE_SIZE);

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Atualizar viewport ao redimensionar
window.addEventListener('resize', () => {
    VIEWPORT_WIDTH = Math.floor(window.innerWidth / TILE_SIZE);
    VIEWPORT_HEIGHT = Math.floor(window.innerHeight / TILE_SIZE);
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
        
        // ===== GAME STATE =====
        const game = {
            state: 'menu',
            playerNick: '',
            startTime: 0,
            elapsedTime: 0,
            score: 0,
            pumpkinsFound: 0,
            gold: 0,
            keys: {},
            touch: { up: false, down: false, left: false, right: false },
            camera: { x: 0, y: 0 },
            selectedTool: null,
            quests: [],
            npcs: [],
            lastUpdate: Date.now()
        };
        
        // ===== PLAYER =====
        const player = {
            x: 10,
            y: 10,
            speed: 0.12,
            health: 100,
            maxHealth: 100,
            energy: 100,
            maxEnergy: 100,
            direction: 'down',
            animFrame: 0,
            animTimer: 0,
            inventory: [],
            isMoving: false
        };
        
        // ===== TILES =====
        const TILES = {
            GRASS: 0,
            WATER: 1,
            SAND: 2,
            STONE: 3,
            TREE: 4,
            ROCK: 5,
            WOOD: 6,
            CAVE: 7,
            DOOR: 8,
            FENCE: 9,
            HOUSE_WALL: 10,
            HOUSE_ROOF: 11,
            FLOOR: 12,
            PATH: 13,
            FLOWER: 14,
            BUSH: 15
        };
        
        // ===== WORLD MAP GENERATION =====
        function generateWorld() {
            const world = [];
            for (let y = 0; y < MAP_HEIGHT; y++) {
                const row = [];
                for (let x = 0; x < MAP_WIDTH; x++) {
                    // Border
                    if (x === 0 || x === MAP_WIDTH - 1 || y === 0 || y === MAP_HEIGHT - 1) {
row.push(TILES.WATER);
                    }
                    // Water area (top-left)
                    else if (x < 8 && y < 8) {
                        row.push(Math.random() > 0.3 ? TILES.WATER : TILES.SAND);
                    }
                    // Mountain area (top-right)
                    else if (x > MAP_WIDTH - 15 && y < 15) {
                        if (Math.random() > 0.6) {
                            row.push(TILES.STONE);
                        } else if (Math.random() > 0.7) {
                            row.push(TILES.ROCK);
                        } else {
                            row.push(TILES.GRASS);
                        }
                    }
                    // Forest area (bottom-left)
                    else if (x < 20 && y > MAP_HEIGHT - 15) {
                        if (Math.random() > 0.5) {
                            row.push(TILES.TREE);
                        } else {
                            row.push(TILES.GRASS);
                        }
                    }
                    // Path
                    else if ((x === 15 && y > 10 && y < MAP_HEIGHT - 5) || 
                             (y === 22 && x > 10 && x < 45)) {
                        row.push(TILES.PATH);
                    }
                    // Random decorations
                    else {
                        const rand = Math.random();
                        if (rand > 0.95) {
                            row.push(TILES.TREE);
                        } else if (rand > 0.92) {
                            row.push(TILES.ROCK);
                        } else if (rand > 0.88) {
                            row.push(TILES.FLOWER);
                        } else if (rand > 0.85) {
                            row.push(TILES.BUSH);
                        } else {
                            row.push(TILES.GRASS);
                        }
                    }
                }
                world.push(row);
            }
            
            // Add houses (com espa√ßamento melhor)
addHouse(world, 25, 15, 5, 4);
addHouse(world, 36, 10, 6, 5);
addHouse(world, 18, 30, 4, 4);
            
            // Add cave entrance
            world[8][MAP_WIDTH - 10] = TILES.CAVE;
            
            return world;
        }
        
        function addHouse(world, startX, startY, width, height) {
    // Roof
    for (let y = startY; y < startY + 2; y++) {
        for (let x = startX; x < startX + width; x++) {
            if (x >= 0 && x < MAP_WIDTH && y >= 0 && y < MAP_HEIGHT) {
                world[y][x] = TILES.HOUSE_ROOF;
            }
        }
    }
    // Walls
    for (let y = startY + 2; y < startY + height; y++) {
        for (let x = startX; x < startX + width; x++) {
            if (x >= 0 && x < MAP_WIDTH && y >= 0 && y < MAP_HEIGHT) {
                world[y][x] = TILES.HOUSE_WALL;
            }
        }
    }
    // Door (FORA da casa)
    const doorX = startX + Math.floor(width / 2);
    const doorY = startY + height; // MUDEI PARA FICAR DO LADO DE FORA
    if (doorX >= 0 && doorX < MAP_WIDTH && doorY >= 0 && doorY < MAP_HEIGHT) {
        world[doorY][doorX] = TILES.DOOR;
    }
    // Interior da casa (abaixo da parede, n√£o acess√≠vel sem chave)
    for (let y = startY + 2; y < startY + height - 1; y++) {
        for (let x = startX + 1; x < startX + width - 1; x++) {
            if (x >= 0 && x < MAP_WIDTH && y >= 0 && y < MAP_HEIGHT) {
                world[y][x] = TILES.FLOOR;
            }
        }
    }
}
        
        const worldMap = generateWorld();
        
        // ===== ITEMS & COLLECTIBLES =====
const items = [
    { x: 12, y: 23, type: 'axe', emoji: 'ü™ì', name: 'Machado', collected: false },
    { x: 50, y: 14, type: 'pickaxe', emoji: '‚õèÔ∏è', name: 'Picareta', collected: false }, // MOVIDA 2 BLOCOS PARA BAIXO
    { x: 23, y: 20, type: 'key', emoji: 'üîë', name: 'Chave', collected: false },
    { x: 18, y: 28, type: 'candy', emoji: 'üç¨', name: 'Doce', collected: false, stackable: true },
    { x: 32, y: 24, type: 'candy', emoji: 'üç¨', name: 'Doce', collected: false, stackable: true },
    { x: 40, y: 30, type: 'potion', emoji: 'üß™', name: 'Po√ß√£o', collected: false, stackable: true },
    { x: 15, y: 38, type: 'potion', emoji: 'üß™', name: 'Po√ß√£o', collected: false, stackable: true },
];

const pumpkins = [
    { x: 28, y: 22, name: 'Ab√≥bora da Casa', collected: false, requires: 'key' }, // AJUSTADA
    { x: 54, y: 10, name: 'Ab√≥bora da Caverna', collected: false, requires: 'pickaxe' },
    { x: 8, y: 40, name: 'Ab√≥bora da Floresta', collected: false, requires: 'axe' },
    { x: 44, y: 36, name: 'Ab√≥bora Escondida', collected: false, requires: null },
    { x: 6, y: 22, name: 'Ab√≥bora da Praia', collected: false, requires: null },
    { x: 38, y: 14, name: 'Ab√≥bora do Campo', collected: false, requires: null }, // AJUSTADA
    { x: 20, y: 34, name: 'Ab√≥bora da Varanda', collected: false, requires: 'key' },
    { x: 50, y: 28, name: 'Ab√≥bora Perdida', collected: false, requires: null },
    { x: 34, y: 8, name: 'Ab√≥bora das Montanhas', collected: false, requires: 'pickaxe' },
    { x: 10, y: 14, name: 'Ab√≥bora da Margem', collected: false, requires: null }
];
        
        // ===== NPCs =====
        const npcs = [
            {
                x: 16, y: 22,
                name: 'Bruxa Morgana',
                emoji: 'üßô‚Äç‚ôÄÔ∏è',
                color: '#9b59b6',
                dialogue: [
                    'Bem-vindo ao Halloween Valley!',
                    'Procuro 10 ab√≥boras m√°gicas perdidas...',
                    'Voc√™ pode me ajudar a encontr√°-las?'
                ],
                quest: 'find_pumpkins',
                questGiven: false
            },
            {
                x: 26, y: 18,
                name: 'Fantasma Fred',
                emoji: 'üëª',
                color: '#ecf0f1',
                dialogue: [
                    'Buuu! Hehe, assustei voc√™?',
                    'Dizem que h√° tesouros escondidos nas casas...',
                    'Mas voc√™ vai precisar de chaves!'
                ],
                quest: null,
                questGiven: false
            },
            {
                x: 36, y: 13,
                name: 'Esqueleto Sam',
                emoji: 'üíÄ',
                color: '#95a5a6',
                dialogue: [
                    'Rattles! Ol√° viajante!',
                    'Cuidado com as montanhas ao norte!',
                    'Voc√™ vai precisar de uma picareta resistente.'
                ],
                quest: null,
                questGiven: false
            },
            {
                x: 12, y: 35,
                name: 'Vampiro Victor',
                emoji: 'üßõ',
                color: '#e74c3c',
                dialogue: [
                    'A floresta √© perigosa √† noite...',
                    'Um machado seria √∫til para abrir caminho.',
                    'Boa sorte, mortal!'
                ],
                quest: null,
                questGiven: false
            }
        ];
        
        // ===== COLLISION SYSTEM =====
        const solidTiles = [
            TILES.WATER, TILES.STONE, TILES.TREE, TILES.ROCK, 
            TILES.WOOD, TILES.FENCE, TILES.HOUSE_WALL, TILES.HOUSE_ROOF
        ];
        
        function getTile(x, y) {
            const col = Math.floor(x);
            const row = Math.floor(y);
            if (row < 0 || row >= MAP_HEIGHT || col < 0 || col >= MAP_WIDTH) {
                return TILES.WATER;
            }
            return worldMap[row][col];
        }
        
        function canMove(x, y) {
            const margin = 0.2;
            const corners = [
                { x: x + margin, y: y + margin },
                { x: x + 0.8, y: y + margin },
                { x: x + margin, y: y + 0.8 },
                { x: x + 0.8, y: y + 0.8 }
            ];
            
            for (let corner of corners) {
                const tile = getTile(corner.x, corner.y);
                
                // Check solid tiles
                if (tile === TILES.STONE || tile === TILES.ROCK) {
                    if (!hasItem('pickaxe')) return false;
                }
                
                if (tile === TILES.TREE) {
                    if (!hasItem('axe')) return false;
                }
                
                if (tile === TILES.DOOR) {
                    if (!hasItem('key')) return false;
                }
                
                if (tile === TILES.CAVE) {
                    if (!hasItem('pickaxe')) return false;
                }
                
                if (solidTiles.includes(tile) && 
                    tile !== TILES.STONE && 
                    tile !== TILES.ROCK && 
                    tile !== TILES.TREE && 
                    tile !== TILES.DOOR && 
                    tile !== TILES.CAVE) {
                    return false;
                }
            }
            return true;
        }
        
        // ===== INVENTORY SYSTEM =====
        function hasItem(type) {
            return player.inventory.some(item => item.type === type);
        }
        
        function addItem(item) {
            // Check if stackable
            if (item.stackable) {
                const existing = player.inventory.find(i => i.type === item.type);
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    player.inventory.push({ ...item, count: 1 });
                }
            } else {
                player.inventory.push({ ...item, count: 1 });
            }
            
            renderInventory();
            showTooltip(`‚úÖ Coletou: ${item.name}!`);
            updateScore(50);
        }
        
        function useItem(index) {
            const item = player.inventory[index];
            if (!item) return;
            
            if (item.type === 'candy') {
                player.energy = Math.min(player.maxEnergy, player.energy + 20);
                updateHUD();
                showTooltip('üç¨ +20 Energia!');
                removeItemFromInventory(index);
                updateScore(10);
            } else if (item.type === 'potion') {
                player.health = Math.min(player.maxHealth, player.health + 30);
                updateHUD();
                showTooltip('üß™ +30 Vida!');
                removeItemFromInventory(index);
                updateScore(10);
            } else {
                // Equip tool
                game.selectedTool = item;
                renderInventory();
                showTooltip(`üîß ${item.name} equipado!`);
            }
        }
        
        function removeItemFromInventory(index) {
            const item = player.inventory[index];
            if (item.count > 1) {
                item.count--;
            } else {
                player.inventory.splice(index, 1);
                if (game.selectedTool && game.selectedTool.type === item.type) {
                    game.selectedTool = null;
                }
            }
            renderInventory();
        }
        
        function renderInventory() {
            const grid = document.getElementById('invGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 12; i++) {
                const slot = document.createElement('div');
                slot.className = 'inv-slot';
                
                if (i < player.inventory.length) {
                    const item = player.inventory[i];
                    slot.classList.add('has-item');
                    slot.textContent = item.emoji;
                    
                    if (item.count > 1) {
                        const count = document.createElement('div');
                        count.className = 'inv-count';
                        count.textContent = item.count;
                        slot.appendChild(count);
                    }
                    
                    if (game.selectedTool && game.selectedTool.type === item.type) {
                        slot.classList.add('selected');
                    }
                    
                    slot.onclick = () => useItem(i);
                }
                
                grid.appendChild(slot);
            }
        }
        
        // ===== DRAWING FUNCTIONS =====
        function drawTile(tile, x, y) {
            const px = x * TILE_SIZE;
            const py = y * TILE_SIZE;
            
            ctx.save();
            
            switch(tile) {
                case TILES.GRASS:
                    // Base grass
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Texture
                    ctx.fillStyle = '#5a8c4b';
                    for (let i = 0; i < 4; i++) {
                        const tx = px + Math.random() * TILE_SIZE;
                        const ty = py + Math.random() * TILE_SIZE;
                        ctx.fillRect(tx, ty, 2, 3);
                    }
                    break;
                    
                case TILES.WATER:
                    ctx.fillStyle = '#4a90e2';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Waves
                    ctx.fillStyle = '#6ab0ff';
                    const waveOffset = Math.sin(Date.now() / 500 + x + y) * 2;
                    ctx.fillRect(px + 4, py + 12 + waveOffset, 10, 2);
                    ctx.fillRect(px + 18, py + 20 + waveOffset, 10, 2);
                    break;
                    
                case TILES.SAND:
                    ctx.fillStyle = '#e8d4a0';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Texture
                    ctx.fillStyle = '#d4c090';
                    for (let i = 0; i < 3; i++) {
                        ctx.fillRect(px + Math.random() * TILE_SIZE, py + Math.random() * TILE_SIZE, 2, 2);
                    }
                    break;
                    
                case TILES.STONE:
                    ctx.fillStyle = '#6b6b6b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Details
                    ctx.fillStyle = '#555';
                    ctx.fillRect(px + 6, py + 6, 10, 10);
                    ctx.fillRect(px + 18, py + 16, 8, 8);
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(px + 8, py + 8, 4, 4);
                    break;
                    
                case TILES.TREE:
                    // Grass base
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Trunk
                    ctx.fillStyle = '#6b4423';
                    ctx.fillRect(px + 12, py + 18, 8, 14);
                    // Leaves (layered circles)
                    ctx.fillStyle = '#2d5016';
                    ctx.beginPath();
                    ctx.arc(px + 16, py + 16, 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#3a6020';
                    ctx.beginPath();
                    ctx.arc(px + 16, py + 14, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#4a7030';
                    ctx.beginPath();
                    ctx.arc(px + 16, py + 12, 6, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case TILES.ROCK:
                    // Grass base
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Rock
                    ctx.fillStyle = '#8b8b8b';
                    ctx.beginPath();
                    ctx.moveTo(px + 16, py + 10);
                    ctx.lineTo(px + 24, py + 20);
                    ctx.lineTo(px + 20, py + 28);
                    ctx.lineTo(px + 12, py + 28);
                    ctx.lineTo(px + 8, py + 20);
                    ctx.closePath();
                    ctx.fill();
                    // Highlight
                    ctx.fillStyle = '#a0a0a0';
                    ctx.beginPath();
                    ctx.moveTo(px + 16, py + 10);
                    ctx.lineTo(px + 20, py + 16);
                    ctx.lineTo(px + 16, py + 18);
                    ctx.lineTo(px + 12, py + 16);
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                case TILES.WOOD:
                    // Grass base
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Wood pile
                    ctx.fillStyle = '#6b4423';
                    ctx.fillRect(px + 6, py + 16, 20, 6);
                    ctx.fillRect(px + 6, py + 22, 20, 6);
                    ctx.fillStyle = '#8b5a33';
                    ctx.fillRect(px + 8, py + 18, 4, 4);
                    ctx.fillRect(px + 18, py + 24, 4, 4);
                    break;
                    
                case TILES.CAVE:
                    // Mountain
                    ctx.fillStyle = '#5a5a5a';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#4a4a4a';
                    ctx.beginPath();
                    ctx.moveTo(px + 16, py + 4);
                    ctx.lineTo(px + 28, py + 28);
                    ctx.lineTo(px + 4, py + 28);
                    ctx.closePath();
                    ctx.fill();
                    // Cave entrance
                    ctx.fillStyle = '#1a1a1a';
                    ctx.beginPath();
                    ctx.arc(px + 16, py + 22, 8, 0, Math.PI);
                    ctx.fill();
                    break;
                    
                case TILES.DOOR:
                    // Grass base
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Door frame
                    ctx.fillStyle = '#6b4423';
                    ctx.fillRect(px + 8, py + 8, 16, 24);
                    ctx.fillStyle = '#8b5a33';
                    ctx.fillRect(px + 10, py + 10, 12, 20);
                    // Handle
                    ctx.fillStyle = '#ffd700';
                    ctx.fillRect(px + 18, py + 20, 2, 3);
                    // Lock indicator
                    if (!hasItem('key')) {
                        ctx.fillStyle = '#ff0000';
                        ctx.beginPath();
                        ctx.arc(px + 16, py + 18, 4, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#cc0000';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(px + 16, py + 16, 3, Math.PI, 0, true);
                        ctx.stroke();
                    }
                    break;
                    
                case TILES.FENCE:
                    // Grass base
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Fence posts
                    ctx.fillStyle = '#8b6914';
                    ctx.fillRect(px + 6, py + 14, 3, 14);
                    ctx.fillRect(px + 15, py + 14, 3, 14);
                    ctx.fillRect(px + 24, py + 14, 3, 14);
                    // Horizontal bars
                    ctx.fillRect(px + 4, py + 18, 24, 2);
                    ctx.fillRect(px + 4, py + 24, 24, 2);
                    break;
                    
                case TILES.HOUSE_WALL:
                    // Wall
                    ctx.fillStyle = '#8b7355';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Bricks
                    ctx.strokeStyle = '#6b5335';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < TILE_SIZE; i += 8) {
                        ctx.strokeRect(px, py + i, TILE_SIZE, 8);
                    }
                    // Window (sometimes)
                    if ((x + y) % 3 === 0) {
                        ctx.fillStyle = '#6ab0ff';
                        ctx.fillRect(px + 8, py + 8, 10, 10);
                        ctx.strokeStyle = '#4a90e2';
                        ctx.strokeRect(px + 12, py + 8, 2, 10);
                        ctx.strokeRect(px + 8, py + 12, 10, 2);
                    }
                    break;
                    
                case TILES.HOUSE_ROOF:
                    // Roof tiles
                    ctx.fillStyle = '#8b3a3a';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#a04545';
                    for (let i = 0; i < TILE_SIZE; i += 4) {
                        ctx.fillRect(px, py + i, TILE_SIZE, 2);
                    }
                    break;
                    
                case TILES.FLOOR:
                    // Wooden floor
                    ctx.fillStyle = '#8b7355';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#9b8365';
                    for (let i = 0; i < TILE_SIZE; i += 8) {
                        ctx.fillRect(px, py + i, TILE_SIZE, 4);
                    }
                    break;
                    
                case TILES.PATH:
                    // Dirt path
                    ctx.fillStyle = '#9b7653';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Stones
                    ctx.fillStyle = '#8b6843';
                    for (let i = 0; i < 3; i++) {
                        const sx = px + Math.random() * TILE_SIZE;
                        const sy = py + Math.random() * TILE_SIZE;
                        ctx.fillRect(sx, sy, 3, 3);
                    }
                    break;
                    
                case TILES.FLOWER:
                    // Grass base
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Flower
                    ctx.fillStyle = '#ff6b9d';
                    ctx.beginPath();
                    ctx.arc(px + 16, py + 16, 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#ffd700';
                    ctx.beginPath();
                    ctx.arc(px + 16, py + 16, 2, 0, Math.PI * 2);
                    ctx.fill();
                    // Stem
                    ctx.strokeStyle = '#2d5016';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(px + 16, py + 20);
                    ctx.lineTo(px + 16, py + 28);
                    ctx.stroke();
                    break;
                    
                case TILES.BUSH:
                    // Grass base
                    ctx.fillStyle = '#4a7c3b';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Bush
                    ctx.fillStyle = '#3a6020';
                    ctx.beginPath();
                    ctx.arc(px + 12, py + 20, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(px + 20, py + 20, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(px + 16, py + 16, 7, 0, Math.PI * 2);
                    ctx.fill();
                    break;
            }
            
            ctx.restore();
        }
        
        function drawPlayer() {
            const screenX = (player.x - game.camera.x) * TILE_SIZE;
            const screenY = (player.y - game.camera.y) * TILE_SIZE;
            const size = TILE_SIZE * 0.9;
            const offset = TILE_SIZE * 0.05;
            
            ctx.save();
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(screenX + TILE_SIZE/2, screenY + size, size/3, size/6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Body (witch costume)
            ctx.fillStyle = '#2d0052';
            ctx.fillRect(screenX + offset + size/3, screenY + offset + size/2, size/3, size/2);
            
            // Cape animation
            const capeOffset = player.isMoving ? Math.sin(Date.now() / 100) * 2 : 0;
            ctx.fillStyle = '#ff6b00';
            ctx.beginPath();
            ctx.moveTo(screenX + offset + size/3, screenY + offset + size/2 + 4);
            ctx.lineTo(screenX + offset - 2 + capeOffset, screenY + offset + size/2 + size/3);
            ctx.lineTo(screenX + offset + size/5, screenY + offset + size - 4);
            ctx.closePath();
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(screenX + offset + size*2/3, screenY + offset + size/2 + 4);
            ctx.lineTo(screenX + offset + size + 2 - capeOffset, screenY + offset + size/2 + size/3);
            ctx.lineTo(screenX + offset + size*4/5, screenY + offset + size - 4);
            ctx.closePath();
            ctx.fill();
            
            // Head
            ctx.fillStyle = '#ffcc99';
            ctx.beginPath();
            ctx.arc(screenX + TILE_SIZE/2, screenY + offset + size/3, size/5, 0, Math.PI * 2);
            ctx.fill();
            
            // Witch hat
            ctx.fillStyle = '#4B0082';
            ctx.beginPath();
            ctx.moveTo(screenX + offset + size/4, screenY + offset + size/6);
            ctx.lineTo(screenX + TILE_SIZE/2, screenY + offset - 4);
            ctx.lineTo(screenX + offset + size*3/4, screenY + offset + size/6);
            ctx.closePath();
            ctx.fill();
            
            // Hat brim
            ctx.fillRect(screenX + offset + size/6, screenY + offset + size/6, size*2/3, 3);
            
            // Face
            ctx.fillStyle = '#000';
            ctx.fillRect(screenX + TILE_SIZE/2 - 5, screenY + offset + size/3 - 2, 2, 2);
            ctx.fillRect(screenX + TILE_SIZE/2 + 3, screenY + offset + size/3 - 2, 2, 2);
            
            // Smile
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(screenX + TILE_SIZE/2, screenY + offset + size/3 + 2, 3, 0, Math.PI);
            ctx.stroke();
            
            // Tool equipped
            if (game.selectedTool) {
                ctx.font = '16px Arial';
                ctx.fillText(game.selectedTool.emoji, screenX + size + 4, screenY + offset + size/2);
            }
            
            ctx.restore();
        }
        
        function drawItem(item, worldX, worldY) {
            const screenX = (worldX - game.camera.x) * TILE_SIZE;
            const screenY = (worldY - game.camera.y) * TILE_SIZE;
            
            // Glow animation
            const time = Date.now() / 400;
const glowSize = 4 + Math.sin(time) * 2;
            
            ctx.save();
            ctx.globalAlpha = 0.4 + Math.sin(time) * 0.2;
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(screenX + TILE_SIZE/2, screenY + TILE_SIZE/2, TILE_SIZE/2 + glowSize, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
            
            // Item floating animation
            const floatOffset = Math.sin(time * 2) * 3;
            
            ctx.font = '28px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(item.emoji, screenX + TILE_SIZE/2, screenY + TILE_SIZE/2 + floatOffset);
        }
        
        function drawPumpkin(worldX, worldY) {
            const screenX = (worldX - game.camera.x) * TILE_SIZE;
            const screenY = (worldY - game.camera.y) * TILE_SIZE;
            const time = Date.now() / 300;
            
            // Magic aura
            ctx.save();
            ctx.globalAlpha = 0.5 + Math.sin(time) * 0.3;
            
            // Outer glow
            const gradient = ctx.createRadialGradient(
                screenX + TILE_SIZE/2, screenY + TILE_SIZE/2, 0,
                screenX + TILE_SIZE/2, screenY + TILE_SIZE/2, TILE_SIZE/2 + 8
            );
            gradient.addColorStop(0, 'rgba(255, 107, 0, 0.8)');
            gradient.addColorStop(1, 'rgba(255, 107, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(screenX + TILE_SIZE/2, screenY + TILE_SIZE/2, TILE_SIZE/2 + 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
            
            // Pumpkin body
            ctx.fillStyle = '#ff8c00';
            ctx.beginPath();
            ctx.ellipse(screenX + TILE_SIZE/2, screenY + TILE_SIZE/2, 12, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Segments
            ctx.strokeStyle = '#cc6600';
            ctx.lineWidth = 2;
            for (let i = -1; i <= 1; i++) {
                ctx.beginPath();
                ctx.moveTo(screenX + TILE_SIZE/2 + i * 6, screenY + TILE_SIZE/2 - 10);
                ctx.lineTo(screenX + TILE_SIZE/2 + i * 6, screenY + TILE_SIZE/2 + 10);
                ctx.stroke();
            }
            
            // Face - evil grin
            ctx.fillStyle = '#000';
            // Eyes (triangular)
            ctx.beginPath();
            ctx.moveTo(screenX + TILE_SIZE/2 - 7, screenY + TILE_SIZE/2 - 3);
            ctx.lineTo(screenX + TILE_SIZE/2 - 4, screenY + TILE_SIZE/2 - 6);
            ctx.lineTo(screenX + TILE_SIZE/2 - 1, screenY + TILE_SIZE/2 - 3);
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(screenX + TILE_SIZE/2 + 1, screenY + TILE_SIZE/2 - 3);
            ctx.lineTo(screenX + TILE_SIZE/2 + 4, screenY + TILE_SIZE/2 - 6);
            ctx.lineTo(screenX + TILE_SIZE/2 + 7, screenY + TILE_SIZE/2 - 3);
            ctx.fill();
            
            // Mouth (zigzag)
            ctx.beginPath();
            ctx.moveTo(screenX + TILE_SIZE/2 - 8, screenY + TILE_SIZE/2 + 3);
            for (let i = 0; i < 5; i++) {
                ctx.lineTo(screenX + TILE_SIZE/2 - 8 + i * 4, screenY + TILE_SIZE/2 + (i % 2 === 0 ? 6 : 3));
            }
            ctx.lineTo(screenX + TILE_SIZE/2 - 8, screenY + TILE_SIZE/2 + 3);
            ctx.fill();
            
            // Stem
            ctx.fillStyle = '#2d5016';
            ctx.fillRect(screenX + TILE_SIZE/2 - 2, screenY + TILE_SIZE/2 - 12, 4, 4);
            
            // Sparkles
            ctx.fillStyle = '#ffa500';
            for (let i = 0; i < 5; i++) {
                const angle = time + i * Math.PI * 2 / 5;
                const radius = TILE_SIZE/2 + 10;
                const sparkleX = screenX + TILE_SIZE/2 + Math.cos(angle) * radius;
                const sparkleY = screenY + TILE_SIZE/2 + Math.sin(angle) * radius;
                ctx.fillRect(sparkleX - 1, sparkleY - 1, 2, 2);
            }
        }
        
        function drawNPC(npc) {
            const screenX = (npc.x - game.camera.x) * TILE_SIZE;
            const screenY = (npc.y - game.camera.y) * TILE_SIZE;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(screenX + TILE_SIZE/2, screenY + TILE_SIZE - 4, 10, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Idle animation
            const bobOffset = Math.sin(Date.now() / 500 + npc.x) * 2;
            
            // Character emoji
            ctx.font = '32px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(npc.emoji, screenX + TILE_SIZE/2, screenY + TILE_SIZE/2 + bobOffset);
            
            // Name tag
            ctx.font = '8px Press Start 2P';
            ctx.fillStyle = '#000';
            ctx.fillText(npc.name, screenX + TILE_SIZE/2 + 1, screenY - 6 + bobOffset + 1);
            ctx.fillStyle = '#fff';
            ctx.fillText(npc.name, screenX + TILE_SIZE/2, screenY - 7 + bobOffset);
            
            // Quest indicator
            if (!npc.questGiven && npc.quest) {
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.arc(screenX + TILE_SIZE/2, screenY - 15 + bobOffset, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#ff8c00';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        // ===== CAMERA =====
        function updateCamera() {
            game.camera.x = player.x - VIEWPORT_WIDTH / 2;
            game.camera.y = player.y - VIEWPORT_HEIGHT / 2;
            
            game.camera.x = Math.max(0, Math.min(game.camera.x, MAP_WIDTH - VIEWPORT_WIDTH));
            game.camera.y = Math.max(0, Math.min(game.camera.y, MAP_HEIGHT - VIEWPORT_HEIGHT));
        }
        
        // ===== MINIMAP =====
        function drawMinimap() {
            const scale = 3;
            minimapCtx.fillStyle = '#000';
            minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);
            
            // Draw world
            for (let y = 0; y < MAP_HEIGHT; y++) {
                for (let x = 0; x < MAP_WIDTH; x++) {
                    const tile = worldMap[y][x];
                    let color = '#4a7c3b'; // grass default
                    
                    if (tile === TILES.WATER) color = '#4a90e2';
                    else if (tile === TILES.STONE) color = '#6b6b6b';
                    else if (tile === TILES.TREE) color = '#2d5016';
                    else if (tile === TILES.HOUSE_WALL || tile === TILES.HOUSE_ROOF) color = '#8b7355';
                    
                    minimapCtx.fillStyle = color;
                    minimapCtx.fillRect(x * scale, y * scale, scale, scale);
                }
            }
            
            // Draw pumpkins
            pumpkins.forEach(pumpkin => {
                if (!pumpkin.collected) {
                    minimapCtx.fillStyle = '#ff8c00';
                    minimapCtx.fillRect(pumpkin.x * scale - 1, pumpkin.y * scale - 1, scale + 2, scale + 2);
                }
            });
            
            // Draw NPCs
            npcs.forEach(npc => {
                minimapCtx.fillStyle = '#ffd700';
                minimapCtx.fillRect(npc.x * scale, npc.y * scale, scale, scale);
            });
            
            // Draw player
            minimapCtx.fillStyle = '#00ff00';
            minimapCtx.fillRect(player.x * scale - 1, player.y * scale - 1, scale + 2, scale + 2);
        }
        
        // ===== RENDER =====
        function render() {
            if (game.state !== 'playing') return;
            
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            updateCamera();
            
            const startCol = Math.floor(game.camera.x);
            const startRow = Math.floor(game.camera.y);
            const endCol = Math.min(startCol + VIEWPORT_WIDTH + 1, MAP_WIDTH);
            const endRow = Math.min(startRow + VIEWPORT_HEIGHT + 1, MAP_HEIGHT);
            
            // Draw tiles
            for (let row = startRow; row < endRow; row++) {
                for (let col = startCol; col < endCol; col++) {
                    const screenX = col - game.camera.x;
                    const screenY = row - game.camera.y;
                    drawTile(worldMap[row][col], screenX, screenY);
                }
            }
            
            // Draw items
            items.forEach(item => {
                if (!item.collected) {
                    const screenX = item.x - game.camera.x;
                    const screenY = item.y - game.camera.y;
                    if (screenX >= -1 && screenX <= VIEWPORT_WIDTH && screenY >= -1 && screenY <= VIEWPORT_HEIGHT) {
                        drawItem(item, item.x, item.y);
                    }
                }
            });
            
            // Draw pumpkins
            pumpkins.forEach(pumpkin => {
                if (!pumpkin.collected) {
                    const screenX = pumpkin.x - game.camera.x;
                    const screenY = pumpkin.y - game.camera.y;
                    if (screenX >= -1 && screenX <= VIEWPORT_WIDTH && screenY >= -1 && screenY <= VIEWPORT_HEIGHT) {
                        drawPumpkin(pumpkin.x, pumpkin.y);
                    }
                }
            });
            
            // Draw NPCs
            npcs.forEach(npc => {
                const screenX = npc.x - game.camera.x;
                const screenY = npc.y - game.camera.y;
                if (screenX >= -1 && screenX <= VIEWPORT_WIDTH && screenY >= -1 && screenY <= VIEWPORT_HEIGHT) {
                    drawNPC(npc);
                }
            });
            
            // Draw player
            drawPlayer();
            
            // Draw minimap
            drawMinimap();
        }
        
        // ===== UPDATE =====
        function update() {
            if (game.state !== 'playing') return;
            
            const now = Date.now();
            const deltaTime = (now - game.lastUpdate) / 16.67; // 60 FPS normalization
            game.lastUpdate = now;
            
            let dx = 0, dy = 0;
            
            if (game.keys.w || game.keys.W || game.keys.ArrowUp || game.touch.up) dy -= 1;
            if (game.keys.s || game.keys.S || game.keys.ArrowDown || game.touch.down) dy += 1;
            if (game.keys.a || game.keys.A || game.keys.ArrowLeft || game.touch.left) dx -= 1;
            if (game.keys.d || game.keys.D || game.keys.ArrowRight || game.touch.right) dx += 1;
            
            player.isMoving = dx !== 0 || dy !== 0;
            
            if (player.isMoving) {
                const length = Math.sqrt(dx * dx + dy * dy);
                dx = (dx / length) * player.speed * deltaTime;
                dy = (dy / length) * player.speed * deltaTime;
                
                const newX = player.x + dx;
                const newY = player.y + dy;
                
                if (canMove(newX, player.y)) {
                    player.x = newX;
                } else {
                    showBlockMessage(getTile(newX, player.y));
                }
                
                if (canMove(player.x, newY)) {
                    player.y = newY;
                } else {
                    showBlockMessage(getTile(player.x, newY));
                }
                
                // Energy consumption
                player.energy = Math.max(0, player.energy - 0.01 * deltaTime);
                
                // Animation
                player.animTimer += deltaTime;
                if (player.animTimer > 8) {
                    player.animFrame = (player.animFrame + 1) % 4;
                    player.animTimer = 0;
                }
            }
            
            // Energy regeneration when not moving
            if (!player.isMoving) {
                player.energy = Math.min(player.maxEnergy, player.energy + 0.05 * deltaTime);
            }
            
            // Check item collection
            items.forEach(item => {
                if (!item.collected) {
                    const dist = Math.sqrt(Math.pow(player.x - item.x, 2) + Math.pow(player.y - item.y, 2));
                    if (dist < 1.5) {
                        item.collected = true;
                        addItem(item);
                    }
                }
            });
            
            // Check pumpkin collection
            pumpkins.forEach(pumpkin => {
                if (!pumpkin.collected) {
                    const dist = Math.sqrt(Math.pow(player.x - pumpkin.x, 2) + Math.pow(player.y - pumpkin.y, 2));
                    if (dist < 1.5) {
                        if (pumpkin.requires && !hasItem(pumpkin.requires)) {
                            showTooltip(`üîí Precisa de: ${getToolName(pumpkin.requires)}!`);
                        } else {
                            pumpkin.collected = true;
                            game.pumpkinsFound++;
                            updateScore(200);
                            showTooltip(`üéÉ ${pumpkin.name} encontrada! (${game.pumpkinsFound}/10)`);
                            updateHUD();
                            
                            if (game.pumpkinsFound >= 10) {
                                setTimeout(victory, 1500);
                            }
                        }
                    }
                }
            });
            
            // Check NPC interaction
            if (game.keys.e || game.keys.E || game.keys[' ']) {
                npcs.forEach(npc => {
                    const dist = Math.sqrt(Math.pow(player.x - npc.x, 2) + Math.pow(player.y - npc.y, 2));
                    if (dist < 2) {
                        interactWithNPC(npc);
                    }
                });
                // Reset key to prevent repeated interaction
                game.keys.e = false;
                game.keys.E = false;
                game.keys[' '] = false;
            }
            
            updateHUD();
        }
        
        let lastBlockTime = 0;
        function showBlockMessage(tile) {
            const now = Date.now();
            if (now - lastBlockTime < 2000) return;
            lastBlockTime = now;
            
            if (tile === TILES.TREE && !hasItem('axe')) {
                showTooltip('üå≤ Precisa do Machado ü™ì!');
            } else if (tile === TILES.DOOR && !hasItem('key')) {
                showTooltip('üîí Precisa da Chave üîë!');
            } else if ((tile === TILES.CAVE || tile === TILES.STONE || tile === TILES.ROCK) && !hasItem('pickaxe')) {
                showTooltip('‚õ∞Ô∏è Precisa da Picareta ‚õèÔ∏è!');
            }
        }
        
        function getToolName(type) {
            const names = {
                'axe': 'Machado ü™ì',
                'pickaxe': 'Picareta ‚õèÔ∏è',
                'key': 'Chave üîë'
            };
            return names[type] || type;
        }
        
        // ===== NPC INTERACTION =====
        function interactWithNPC(npc) {
            showTooltip(`üí¨ Conversando com ${npc.name}...`);
            
            setTimeout(() => {
                const dialogueText = npc.dialogue.join('\n\n');
                showTooltip(`${npc.emoji} ${npc.name}:\n\n${dialogueText}`);
                
                if (npc.quest && !npc.questGiven) {
                    npc.questGiven = true;
                    addQuest(npc.quest);
                    updateScore(100);
                }
            }, 500);
        }
        
        // ===== QUEST SYSTEM =====
        function addQuest(questId) {
            const quests = {
                'find_pumpkins': {
                    id: 'find_pumpkins',
                    name: 'Encontrar 10 Ab√≥boras M√°gicas',
                    description: 'Ajude a Bruxa Morgana a encontrar as ab√≥boras perdidas pelo vale.',
                    progress: 0,
                    total: 10
                }
            };
            
            if (quests[questId] && !game.quests.find(q => q.id === questId)) {
                game.quests.push(quests[questId]);
                updateQuestPanel();
                showTooltip(`üìú Nova miss√£o: ${quests[questId].name}!`);
            }
        }
        
        function updateQuestPanel() {
            const questList = document.getElementById('questList');
            questList.innerHTML = '';
            
            game.quests.forEach(quest => {
                const questDiv = document.createElement('div');
                questDiv.className = 'quest-item';
                
                if (quest.id === 'find_pumpkins') {
                    quest.progress = game.pumpkinsFound;
                }
                
                const completed = quest.progress >= quest.total;
                if (completed) questDiv.classList.add('completed');
                
                questDiv.innerHTML = `
                    ${quest.name}<br>
                    <span style="color: ${completed ? '#00ff88' : '#ffa500'};">
                        ${quest.progress}/${quest.total} ${completed ? '‚úì' : ''}
                    </span>
                `;
                
                questList.appendChild(questDiv);
            });
        }
        
        // ===== HUD UPDATE =====
        function updateHUD() {
            document.getElementById('playerName').textContent = game.playerNick;
            document.getElementById('healthValue').textContent = Math.floor(player.health);
            document.getElementById('healthBar').style.width = (player.health / player.maxHealth * 100) + '%';
            document.getElementById('energyValue').textContent = Math.floor(player.energy);
            document.getElementById('energyBar').style.width = (player.energy / player.maxEnergy * 100) + '%';
            document.getElementById('goldValue').textContent = game.gold;
            document.getElementById('pumpkinCount').textContent = game.pumpkinsFound;
            
            // Update time
            game.elapsedTime = Date.now() - game.startTime;
            document.getElementById('timeValue').textContent = RankingSystem.formatTime(game.elapsedTime);
        }
        
        function updateScore(points) {
            game.score += points;
            game.gold += Math.floor(points / 10);
        }
        
        // ===== TOOLTIP =====
        function showTooltip(text) {
            const existing = document.querySelector('.tooltip');
            if (existing) existing.remove();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = text.replace(/\n/g, '<br>');
            document.body.appendChild(tooltip);
            
            setTimeout(() => tooltip.remove(), 2500);
        }
        
        // ===== GAME LOOP =====
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // ===== CONTROLS =====
        document.addEventListener('keydown', e => {
            game.keys[e.key] = true;
            
            if (e.key === 'Escape' && game.state === 'playing') {
                // Pause menu (opcional)
            }
        });
        
        document.addEventListener('keyup', e => {
            game.keys[e.key] = false;
        });
        
        // Mobile controls
        document.querySelectorAll('.btn-dpad').forEach(btn => {
            const dir = btn.dataset.dir;
            
            btn.addEventListener('touchstart', e => {
                e.preventDefault();
                game.touch[dir] = true;
            });
            
            btn.addEventListener('touchend', e => {
                e.preventDefault();
                game.touch[dir] = false;
            });
        });
        
        document.getElementById('btnInteract').addEventListener('touchstart', e => {
            e.preventDefault();
            game.keys.e = true;
            setTimeout(() => game.keys.e = false, 100);
        });
        
        document.getElementById('btnInteract').addEventListener('click', e => {
            game.keys.e = true;
            setTimeout(() => game.keys.e = false, 100);
        });
        
        // ===== MENU FUNCTIONS =====
        function submitNick() {
            const nick = document.getElementById('nickInput').value.trim();
            
            if (nick.length < 2) {
                showTooltip('‚ö†Ô∏è Nick deve ter pelo menos 2 caracteres!');
                return;
            }
            
            game.playerNick = nick;
            document.getElementById('nickScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
        
// ===== FULLSCREEN TOGGLE =====
function toggleFullscreen() {
    const elem = document.documentElement;
    
    if (!document.fullscreenElement) {
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        }
        document.getElementById('fullscreenBtn').textContent = 'üñ•Ô∏è SAIR TELA CHEIA';
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        document.getElementById('fullscreenBtn').textContent = 'üñ•Ô∏è TELA CHEIA';
    }
}
       
        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('inventory').classList.remove('hidden');
            document.getElementById('minimap').classList.remove('hidden');
            document.getElementById('fullscreenBtn').style.display = 'block';
            document.getElementById('questPanel').classList.remove('hidden');
            
            game.state = 'playing';
            game.startTime = Date.now();
            game.lastUpdate = Date.now();
            game.pumpkinsFound = 0;
            game.score = 0;
            game.gold = 0;
            game.quests = [];
            
            player.x = 10;
            player.y = 10;
            player.health = 100;
            player.energy = 100;
            player.inventory = [];
            game.selectedTool = null;
            
            items.forEach(item => item.collected = false);
            pumpkins.forEach(pumpkin => pumpkin.collected = false);
            npcs.forEach(npc => npc.questGiven = false);
            
            renderInventory();
            updateHUD();
            updateQuestPanel();
            gameLoop();
        }
        
        function victory() {
            game.state = 'victory';
            const finalTime = Date.now() - game.startTime;
            const finalScore = game.score + game.gold * 10;
            
            // Save to ranking
            RankingSystem.saveScore(game.playerNick, finalTime, game.pumpkinsFound, finalScore);
            
            // Update victory screen
            document.getElementById('finalTime').textContent = RankingSystem.formatTime(finalTime);
            document.getElementById('finalScore').textContent = finalScore;
            
            const capeCode = window._getCape();
            document.getElementById('capeCode').textContent = capeCode;
            
            document.getElementById('victoryScreen').classList.remove('hidden');
        }
        
        function copyCape() {
            const code = document.getElementById('capeCode').textContent;
            const button = event.target;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                    button.textContent = '‚úÖ COPIADO!';
                    setTimeout(() => button.textContent = 'üìã COPIAR C√ìDIGO', 2000);
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showTooltip('üìã C√≥digo copiado!');
                button.textContent = '‚úÖ COPIADO!';
                setTimeout(() => button.textContent = 'üìã COPIAR C√ìDIGO', 2000);
            }
        }
        
        function showRankings() {
            document.getElementById('nickScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('rankingsScreen').classList.remove('hidden');
            switchRankingTab('score');
        }
        
        function showRankingsFromVictory() {
            document.getElementById('victoryScreen').classList.add('hidden');
            document.getElementById('rankingsScreen').classList.remove('hidden');
            switchRankingTab('score');
        }
        
        function closeRankings() {
            document.getElementById('rankingsScreen').classList.add('hidden');
            
            if (game.state === 'victory') {
                document.getElementById('victoryScreen').classList.remove('hidden');
            } else if (game.playerNick) {
                document.getElementById('startScreen').classList.remove('hidden');
            } else {
                document.getElementById('nickScreen').classList.remove('hidden');
            }
        }
        
        function switchRankingTab(type) {
            let rankings = [];
            let title = '';
            let emptyMessage = '';
            
            switch(type) {
                case 'score':
                    rankings = RankingSystem.getTopScore();
                    title = 'üíØ TOP 10 PONTUA√á√ÉO';
                    emptyMessage = 'Nenhuma partida registrada ainda!';
                    break;
                case 'speed':
                    rankings = RankingSystem.getTopSpeed();
                    title = '‚ö° TOP 10 MAIS R√ÅPIDOS (Jogo Completo)';
                    emptyMessage = 'Nenhum jogador completou o jogo ainda!';
                    break;
                case 'pumpkins':
                    rankings = RankingSystem.getTopPumpkins();
                    title = 'üéÉ TOP 10 MAIS AB√ìBORAS';
                    emptyMessage = 'Nenhuma partida registrada ainda!';
                    break;
            }
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="font-size: 16px; color: #ffa500; text-shadow: 0 0 10px rgba(255,165,0,0.8);">
                        ${title}
                    </h2>
                </div>
            `;
            
            if (rankings.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: #888; font-size: 12px;">
                        ${emptyMessage}
                    </div>
                `;
            } else {
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += `
                    <thead>
                        <tr style="border-bottom: 2px solid #ff6b00; color: #ffa500;">
                            <th style="padding: 12px; text-align: left;">#</th>
                            <th style="padding: 12px; text-align: left;">NICK</th>
                            <th style="padding: 12px; text-align: center;">üéÉ</th>
                            <th style="padding: 12px; text-align: center;">üí∞</th>
                            <th style="padding: 12px; text-align: center;">‚è±Ô∏è</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                rankings.forEach((entry, index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    const isPlayer = entry.nick === game.playerNick;
                    const rowClass = isPlayer ? 'player-row' : '';
                    
                    html += `
                        <tr class="${rowClass}">
                            <td style="padding: 10px;">${medal} ${index + 1}¬∫</td>
                            <td style="padding: 10px; ${isPlayer ? 'font-weight: bold;' : ''}">${entry.nick} ${isPlayer ? '‚≠ê' : ''}</td>
                            <td style="padding: 10px; text-align: center;">${entry.pumpkins}/10</td>
                            <td style="padding: 10px; text-align: center;">${entry.score}</td>
                            <td style="padding: 10px; text-align: center;">${RankingSystem.formatTime(entry.time)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('rankingContent').innerHTML = html;
        }
        
        function showControls() {
showTooltip(`üéÆ CONTROLES:\n\nPC: WASD ou Setas para mover\nE ou Espa√ßo para interagir\n\nMobile: Use os controles na tela\n\nInvent√°rio: Clique nos itens para usar/equipar`);
        }
        
        function showCredits() {
            document.getElementById('victoryScreen').classList.add('hidden');
            document.getElementById('creditsScreen').classList.remove('hidden');
        }
        
        function closeCredits() {
            document.getElementById('creditsScreen').classList.add('hidden');
            document.getElementById('victoryScreen').classList.remove('hidden');
        }
        
        function restartGame() {
            document.getElementById('victoryScreen').classList.add('hidden');
            document.getElementById('creditsScreen').classList.add('hidden');
            document.getElementById('rankingsScreen').classList.add('hidden');
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('inventory').classList.add('hidden');
            document.getElementById('minimap').classList.add('hidden');
            document.getElementById('questPanel').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            
            game.state = 'menu';
        }
        
// Atalho F11 para fullscreen
document.addEventListener('keydown', (e) => {
    if (e.key === 'F11') {
        e.preventDefault();
        toggleFullscreen();
    }
});

        // ===== BACKGROUND STARS =====
        function createStars() {
            const bgStars = document.getElementById('bgStars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = (Math.random() * 2 + 1) + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                bgStars.appendChild(star);
            }
        }
        
        // ===== LOADING =====
        function simulateLoading() {
            let progress = 0;
            const loadingFill = document.getElementById('loadingFill');
            const loadingText = document.getElementById('loadingText');
            
            const loadingMessages = [
                'Gerando mundo m√°gico...',
                'Plantando ab√≥boras...',
                'Invocando NPCs...',
                'Preparando ferramentas...',
                'Carregando tesouros...',
                'Quase pronto...'
            ];
            
            const interval = setInterval(() => {
                progress += Math.random() * 15 + 5;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                    }, 500);
                }
                
                loadingFill.style.width = progress + '%';
                const messageIndex = Math.floor((progress / 100) * loadingMessages.length);
                loadingText.textContent = loadingMessages[Math.min(messageIndex, loadingMessages.length - 1)];
            }, 300);
        }
        
        // ===== INITIALIZATION =====
        window.addEventListener('load', () => {
            createStars();
            simulateLoading();
            renderInventory();
        });
        
        // ===== ENTER KEY ON NICK INPUT =====
        document.getElementById('nickInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitNick();
            }
        });
        
        // ===== PREVENT CONTEXT MENU =====
        canvas.addEventListener('contextmenu', e => e.preventDefault());
        
        // ===== MOBILE DETECTION =====
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        if (isMobile()) {
            document.querySelectorAll('.mobile-controls, .action-buttons').forEach(el => {
                el.style.display = 'flex';
            });
        }
        
        // ===== PREVENT SCROLL ON MOBILE =====
        document.body.addEventListener('touchmove', (e) => {
            if (game.state === 'playing') {
                e.preventDefault();
            }
        }, { passive: false });
        
        // ===== AUTO SAVE (OPTIONAL) =====
        function autoSave() {
            if (game.state === 'playing') {
                const saveData = {
                    playerNick: game.playerNick,
                    playerX: player.x,
                    playerY: player.y,
                    health: player.health,
                    energy: player.energy,
                    inventory: player.inventory,
                    pumpkinsFound: game.pumpkinsFound,
                    score: game.score,
                    gold: game.gold,
                    collectedItems: items.map(i => i.collected),
                    collectedPumpkins: pumpkins.map(p => p.collected),
                    quests: game.quests,
                    startTime: game.startTime
                };
                
                localStorage.setItem('halloweenValleySave', JSON.stringify(saveData));
            }
        }
        
        function loadSave() {
            const saveData = localStorage.getItem('halloweenValleySave');
            if (saveData) {
                try {
                    const data = JSON.parse(saveData);
                    
                    // Ask player if they want to continue
                    const continueGame = confirm(`Continuar jogo salvo de ${data.playerNick}?\n\nProgresso: ${data.pumpkinsFound}/10 ab√≥boras\nPontua√ß√£o: ${data.score}`);
                    
                    if (continueGame) {
                        game.playerNick = data.playerNick;
                        player.x = data.playerX;
                        player.y = data.playerY;
                        player.health = data.health;
                        player.energy = data.energy;
                        player.inventory = data.inventory;
                        game.pumpkinsFound = data.pumpkinsFound;
                        game.score = data.score;
                        game.gold = data.gold;
                        game.quests = data.quests;
                        game.startTime = data.startTime;
                        
                        data.collectedItems.forEach((collected, index) => {
                            if (items[index]) items[index].collected = collected;
                        });
                        
                        data.collectedPumpkins.forEach((collected, index) => {
                            if (pumpkins[index]) pumpkins[index].collected = collected;
                        });
                        
                        // Auto start game
                        document.getElementById('nickInput').value = data.playerNick;
                        submitNick();
                        setTimeout(() => startGame(), 100);
                    }
                } catch (e) {
                    console.error('Error loading save:', e);
                }
            }
        }
        
        // Auto save every 30 seconds
        setInterval(autoSave, 30000);
        
        // Check for saved game on load
        setTimeout(() => {
            if (localStorage.getItem('halloweenValleySave')) {
                loadSave();
            }
        }, 1000);
        
        // Save on page unload
        window.addEventListener('beforeunload', () => {
            autoSave();
        });
        
        // ===== CHEAT CODES (EASTER EGG) =====
        let cheatInput = '';
        document.addEventListener('keypress', (e) => {
            cheatInput += e.key;
            cheatInput = cheatInput.slice(-10); // Keep last 10 chars
            
            // Cheat: "halloween"
            if (cheatInput.includes('halloween')) {
                player.health = player.maxHealth;
                player.energy = player.maxEnergy;
                game.gold += 1000;
                showTooltip('üéÉ CHEAT ATIVADO! +1000 Ouro e Vida/Energia cheias!');
                cheatInput = '';
            }
            
            // Cheat: "pumpkin"
            if (cheatInput.includes('pumpkin')) {
                const uncollected = pumpkins.find(p => !p.collected);
                if (uncollected) {
                    player.x = uncollected.x;
                    player.y = uncollected.y;
                    showTooltip('üéÉ Teleportado para pr√≥xima ab√≥bora!');
                }
                cheatInput = '';
            }
            
            // Cheat: "speed"
            if (cheatInput.includes('speed')) {
                player.speed = 0.25;
                showTooltip('‚ö° VELOCIDADE AUMENTADA!');
                cheatInput = '';
            }
        });
        
        // ===== ACHIEVEMENT SYSTEM (BONUS) =====
        const achievements = [
            { id: 'first_pumpkin', name: 'Primeira Ab√≥bora', description: 'Encontre sua primeira ab√≥bora', unlocked: false },
            { id: 'half_way', name: 'Meio Caminho', description: 'Encontre 5 ab√≥boras', unlocked: false },
            { id: 'speed_runner', name: 'Velocista', description: 'Complete em menos de 10 minutos', unlocked: false },
            { id: 'collector', name: 'Colecionador', description: 'Colete todos os itens', unlocked: false },
            { id: 'social', name: 'Socialite', description: 'Fale com todos os NPCs', unlocked: false }
        ];
        
        function checkAchievements() {
            // First pumpkin
            if (game.pumpkinsFound >= 1 && !achievements[0].unlocked) {
                achievements[0].unlocked = true;
                showAchievement(achievements[0]);
            }
            
            // Half way
            if (game.pumpkinsFound >= 5 && !achievements[1].unlocked) {
                achievements[1].unlocked = true;
                showAchievement(achievements[1]);
            }
            
            // Speed runner
            if (game.pumpkinsFound >= 10 && game.elapsedTime < 600000 && !achievements[2].unlocked) {
                achievements[2].unlocked = true;
                showAchievement(achievements[2]);
            }
            
            // Collector
            const allItemsCollected = items.every(i => i.collected);
            if (allItemsCollected && !achievements[3].unlocked) {
                achievements[3].unlocked = true;
                showAchievement(achievements[3]);
            }
            
            // Social
            const allNPCsTalked = npcs.every(n => n.questGiven || !n.quest);
            if (allNPCsTalked && !achievements[4].unlocked) {
                achievements[4].unlocked = true;
                showAchievement(achievements[4]);
            }
        }
        
        function showAchievement(achievement) {
            const achievementDiv = document.createElement('div');
            achievementDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ffa500 0%, #ff6b00 100%);
                border: 4px solid #fff;
                border-radius: 15px;
                padding: 20px;
                z-index: 500;
                box-shadow: 0 0 40px rgba(255, 165, 0, 0.9);
                animation: slideInRight 0.5s, slideOutRight 0.5s 4s;
                max-width: 300px;
            `;
            
            achievementDiv.innerHTML = `
                <div style="font-size: 14px; color: #fff; text-shadow: 2px 2px 0 #000; margin-bottom: 10px;">
                    üèÜ CONQUISTA DESBLOQUEADA!
                </div>
                <div style="font-size: 12px; color: #fff; text-shadow: 2px 2px 0 #000; font-weight: bold;">
                    ${achievement.name}
                </div>
                <div style="font-size: 9px; color: #fff; text-shadow: 1px 1px 0 #000; margin-top: 5px;">
                    ${achievement.description}
                </div>
            `;
            
            document.body.appendChild(achievementDiv);
            
            setTimeout(() => {
                achievementDiv.remove();
            }, 4500);
            
            updateScore(500);
        }
        
        // Add achievement check to update loop
        setInterval(() => {
            if (game.state === 'playing') {
                checkAchievements();
            }
        }, 1000);
        
        // ===== CSS ANIMATIONS FOR ACHIEVEMENTS =====
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        
        // ===== SOUND EFFECTS (OPTIONAL - Web Audio API) =====
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(frequency, duration, type = 'sine') {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // Sound effects wrapper
        const sounds = {
            collect: () => playSound(800, 0.1, 'square'),
            pumpkin: () => {
                playSound(500, 0.1);
                setTimeout(() => playSound(600, 0.1), 100);
                setTimeout(() => playSound(700, 0.2), 200);
            },
            interact: () => playSound(400, 0.1, 'triangle'),
            error: () => playSound(200, 0.2, 'sawtooth')
        };
        
        // Add sound effects to game events
        const originalAddItem = addItem;
        addItem = function(item) {
            sounds.collect();
            return originalAddItem.call(this, item);
        };
        
        // ===== PARTICLE EFFECTS =====
        class Particle {
            constructor(x, y, color, velocityX, velocityY) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.velocityX = velocityX;
                this.velocityY = velocityY;
                this.life = 1;
                this.decay = 0.02;
            }
            
            update() {
                this.x += this.velocityX;
                this.y += this.velocityY;
                this.velocityY += 0.1; // gravity
                this.life -= this.decay;
                return this.life > 0;
            }
            
            draw(ctx, cameraX, cameraY) {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                const screenX = (this.x - cameraX) * TILE_SIZE;
                const screenY = (this.y - cameraY) * TILE_SIZE;
                ctx.fillRect(screenX, screenY, 4, 4);
                ctx.restore();
            }
        }
        
        const particles = [];
        
        function createParticleExplosion(x, y, color, count = 20) {
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 * i) / count;
                const speed = Math.random() * 0.1 + 0.05;
                particles.push(new Particle(
                    x,
                    y,
                    color,
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed - 0.1
                ));
            }
        }
        
        // Update particles in game loop
        const originalRender = render;
        render = function() {
            originalRender.call(this);
            
            // Update and draw particles
            for (let i = particles.length - 1; i >= 0; i--) {
                if (!particles[i].update()) {
                    particles.splice(i, 1);
                } else {
                    particles[i].draw(ctx, game.camera.x, game.camera.y);
                }
            }
        };
        
        // Add particle effect when collecting pumpkin
        const originalPumpkinCollect = pumpkins;
        pumpkins.forEach(pumpkin => {
            const originalCollected = Object.getOwnPropertyDescriptor(pumpkin, 'collected');
            Object.defineProperty(pumpkin, 'collected', {
                get: function() {
                    return this._collected;
                },
                set: function(value) {
                    if (value && !this._collected) {
                        createParticleExplosion(this.x, this.y, '#ff8c00', 30);
                        sounds.pumpkin();
                    }
                    this._collected = value;
                }
            });
            pumpkin._collected = false;
        });
        
        // ===== CONSOLE WELCOME MESSAGE =====
        console.log('%cüéÉ HALLOWEEN VALLEY üéÉ', 'font-size: 24px; color: #ff8c00; font-weight: bold; text-shadow: 2px 2px 0 #000;');
        console.log('%cDesenvolvido por VEGOTS - YORUS', 'font-size: 14px; color: #00ff88;');
        console.log('%cVers√£o 1.0.0', 'font-size: 12px; color: #888;');
        console.log('%c\nCheats dispon√≠veis:\n- Digite "halloween" para ganhar 1000 de ouro\n- Digite "pumpkin" para teleportar para pr√≥xima ab√≥bora\n- Digite "speed" para aumentar velocidade', 'font-size: 10px; color: #ffa500;');
        
        // ===== FINAL MESSAGE =====
        console.log('%c\n‚ú® Jogo carregado com sucesso! Divirta-se! ‚ú®', 'font-size: 14px; color: #00ff88; font-weight: bold;');
    </script>

<!-- Fullscreen Button -->
<button id="fullscreenBtn" style="
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ff6b00 0%, #cc5500 100%);
    border: 3px solid #fff;
    border-radius: 10px;
    padding: 10px 20px;
    font-family: 'Press Start 2P', cursive;
    font-size: 10px;
    color: #fff;
    cursor: pointer;
    z-index: 200;
    box-shadow: 0 0 20px rgba(255, 107, 0, 0.8);
    display: none;
" onclick="toggleFullscreen()">
    üñ•Ô∏è TELA CHEIA
</button>

</body>
</html>
